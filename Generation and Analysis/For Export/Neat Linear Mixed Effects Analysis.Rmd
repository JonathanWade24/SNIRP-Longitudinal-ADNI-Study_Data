---
title: "Longitudinal Traumatic Brain Injury Effects in Alzheimerâ€™s Disease Neuroimaging Initiative Sample"
output: html_notebook
---

```{r setup, include=FALSE}
# Load necessary libraries
knitr::opts_knit$set(root.dir = 'C:/Users/jonat/Documents/SNIRP-Thesis/ROI-Flat File Generation/For Export')
library(tidyverse)
library(lme4)
library(lmerTest)
library(MASS)
library(lubridate)
library(tidymodels)
library(janitor)
library(broom.mixed)
library(doParallel)
library(foreach)
library(performance)
tidymodels_prefer()
set.seed(333)
```

## Data Import and Preparation

In this section, we import the necessary datasets and prepare them for analysis by merging severity data and cleaning column names.

```{r data-import}
# Load datasets
Severity <- read_csv('Data Import/Final_TBI_With_Severity.csv')
GM <- read_csv('1_to_1Matching/merged_GM_2024-02-23.csv')
WM <- read_csv('1_to_1Matching/merged_WM_2024-02-23.csv')
Thick <- read_csv('1_to_1Matching/merged_Thick_2024-02-23.csv')
CSF <- read_csv('1_to_1Matching/merged_CSF_2024-02-23.csv')

# Merge severity data and clean column names
datasets <- list(GM = GM, WM = WM, Thick = Thick, CSF = CSF)
datasets <- lapply(datasets, function(df) {
  df %>%
    left_join(Severity %>% select(RID, injury_severity), by = "RID") %>%
    mutate(injury_severity = ifelse(is.na(injury_severity), 0, injury_severity)) %>%
    clean_names()
})

GM <- datasets$GM
WM <- datasets$WM
Thick <- datasets$Thick
CSF <- datasets$CSF
```

## Define Regions of Interest (ROIs)

We define the regions of interest (ROIs) that will be analyzed in this study.

```{r define-rois}
# Define ROIs
GM_ROIs <- c("x3rd_ventricle", "x4th_ventricle", "right_accumbens_area", "left_accumbens_area",
             "right_amygdala", "left_amygdala", "brain_stem", "right_caudate", "left_caudate",
             "right_cerebellum_exterior", "left_cerebellum_exterior", "right_cerebellum_white_matter",
             "left_cerebellum_white_matter", "right_cerebral_white_matter", "left_cerebral_white_matter",
             "csf", "right_hippocampus", "left_hippocampus", "right_inf_lat_vent", "left_inf_lat_vent",
             "right_lateral_ventricle", "left_lateral_ventricle", "right_pallidum", "left_pallidum",
             "right_putamen", "left_putamen", "right_thalamus_proper", "left_thalamus_proper",
             "right_ventral_dc", "left_ventral_dc", "optic_chiasm", "cerebellar_vermal_lobules_i_v",
             "cerebellar_vermal_lobules_vi_vii", "cerebellar_vermal_lobules_viii_x", "left_basal_forebrain",
             "right_basal_forebrain", "right_a_cg_g_anterior_cingulate_gyrus", "left_a_cg_g_anterior_cingulate_gyrus",
             "right_a_ins_anterior_insula", "left_a_ins_anterior_insula", "right_a_or_g_anterior_orbital_gyrus",
             "left_a_or_g_anterior_orbital_gyrus", "right_an_g_angular_gyrus", "left_an_g_angular_gyrus",
             "right_calc_calcarine_cortex", "left_calc_calcarine_cortex", "right_co_central_operculum",
             "left_co_central_operculum", "right_cun_cuneus", "left_cun_cuneus", "right_ent_entorhinal_area",
             "left_ent_entorhinal_area", "right_fo_frontal_operculum", "left_fo_frontal_operculum",
             "right_frp_frontal_pole", "left_frp_frontal_pole", "right_fu_g_fusiform_gyrus",
             "left_fu_g_fusiform_gyrus", "right_g_re_gyrus_rectus", "left_g_re_gyrus_rectus",
             "right_iog_inferior_occipital_gyrus", "left_iog_inferior_occipital_gyrus", "right_itg_inferior_temporal_gyrus",
             "left_itg_inferior_temporal_gyrus", "right_li_g_lingual_gyrus", "left_li_g_lingual_gyrus",
             "right_l_or_g_lateral_orbital_gyrus", "left_l_or_g_lateral_orbital_gyrus", "right_m_cg_g_middle_cingulate_gyrus",
             "left_m_cg_g_middle_cingulate_gyrus", "right_mfc_medial_frontal_cortex", "left_mfc_medial_frontal_cortex",
             "right_mfg_middle_frontal_gyrus", "left_mfg_middle_frontal_gyrus", "right_mog_middle_occipital_gyrus",
             "left_mog_middle_occipital_gyrus", "right_m_or_g_medial_orbital_gyrus", "left_m_or_g_medial_orbital_gyrus",
             "right_m_po_g_postcentral_gyrus_medial_segment", "left_m_po_g_postcentral_gyrus_medial_segment",
             "right_m_pr_g_precentral_gyrus_medial_segment", "left_m_pr_g_precentral_gyrus_medial_segment",
             "right_msfg_superior_frontal_gyrus_medial_segment", "left_msfg_superior_frontal_gyrus_medial_segment",
             "right_mtg_middle_temporal_gyrus", "left_mtg_middle_temporal_gyrus", "right_ocp_occipital_pole",
             "left_ocp_occipital_pole", "right_o_fu_g_occipital_fusiform_gyrus", "left_o_fu_g_occipital_fusiform_gyrus",
             "right_op_ifg_opercular_part_of_the_inferior_frontal_gyrus", "left_op_ifg_opercular_part_of_the_inferior_frontal_gyrus",
             "right_or_ifg_orbital_part_of_the_inferior_frontal_gyrus", "left_or_ifg_orbital_part_of_the_inferior_frontal_gyrus",
             "right_p_cg_g_posterior_cingulate_gyrus", "left_p_cg_g_posterior_cingulate_gyrus",
             "right_p_cu_precuneus", "left_p_cu_precuneus", "right_phg_parahippocampal_gyrus", "left_phg_parahippocampal_gyrus",
             "right_p_ins_posterior_insula", "left_p_ins_posterior_insula", "right_po_parietal_operculum",
             "left_po_parietal_operculum", "right_po_g_postcentral_gyrus", "left_po_g_postcentral_gyrus",
             "right_p_or_g_posterior_orbital_gyrus", "left_p_or_g_posterior_orbital_gyrus", "right_pp_planum_polare",
             "left_pp_planum_polare", "right_pr_g_precentral_gyrus", "left_pr_g_precentral_gyrus", "right_pt_planum_temporale",
             "left_pt_planum_temporale", "right_sca_subcallosal_area", "left_sca_subcallosal_area",
             "right_sfg_superior_frontal_gyrus", "left_sfg_superior_frontal_gyrus", "right_smc_supplementary_motor_cortex",
             "left_smc_supplementary_motor_cortex", "right_smg_supramarginal_gyrus", "left_smg_supramarginal_gyrus",
             "right_sog_superior_occipital_gyrus", "left_sog_superior_occipital_gyrus", "right_spl_superior_parietal_lobule",
             "left_spl_superior_parietal_lobule", "right_stg_superior_temporal_gyrus", "left_stg_superior_temporal_gyrus",
             "right_tmp_temporal_pole", "left_tmp_temporal_pole", "right_tr_ifg_triangular_part_of_the_inferior_frontal_gyrus",
             "left_tr_ifg_triangular_part_of_the_inferior_frontal_gyrus", "right_ttg_transverse_temporal_gyrus",
             "left_ttg_transverse_temporal_gyrus")
```

## Data Transformation

In this section, we apply necessary transformations to the datasets, including the calculation of months since the baseline exam, recoding of injury severity, and more.

```{r data-transformation}
# Function to apply transformations
apply_transformations <- function(df) {
  df %>%
    mutate(
      months_since_bl_exam = as.numeric(difftime(ymd(examdate), ymd(examdate_bl), units = "days")) / 30.44,
      new_injury_severity = factor(case_when(
        injury_severity %in% c(0, 1) ~ as.character(injury_severity

),
        injury_severity %in% c(2, 3, 4) ~ "2",
        TRUE ~ NA_character_
      )),
      ptgender = factor(ptgender, levels = c('Female', 'Male')),
      pteducat = as.numeric(pteducat),
      apoe4 = factor(apoe4, levels = c('0', '1', '2')),
      tbi = as.factor(tbi),
      examdate = ymd(examdate),
      new_injury_severity = factor(new_injury_severity, levels = c("0", "1", "2")),
      dx = ifelse(is.na(dx), as.character(dx_bl), as.character(dx)),
      dx = case_when(
        dx %in% c('LMCI', 'EMCI', 'SMC') ~ 'MCI',
        TRUE ~ as.character(dx)
      ),
      dx = factor(dx, levels = c("CN", "MCI", "Dementia"))
    )
}

# Apply transformations
Thick_transformed <- apply_transformations(Thick)
GM_transformed <- apply_transformations(GM)
CSF_transformed <- apply_transformations(CSF)
WM_transformed <- apply_transformations(WM)
```

## Recode and Replace Missing Values

We recode `dx_bl` values and replace missing values in `dx` with the corresponding `dx_bl` values.

```{r recode-replace-na}
# Recode dx_bl for each dataset
recode_dx_bl <- function(df) {
  df$dx_bl <- as.character(df$dx_bl)
  df$dx_bl[df$dx_bl %in% c("EMCI", "LMCI", "SMC")] <- "MCI"
  df$dx_bl[df$dx_bl %in% c("AD")] <- "Dementia"
  df
}

# Replace NA values in dx with dx_bl
replace_na_dx <- function(df) {
  df$dx[is.na(df$dx)] <- df$dx_bl[is.na(df$dx)]
  df
}

# Apply recoding and replacement functions
Thick_transformed <- Thick_transformed |> recode_dx_bl() |> replace_na_dx()
GM_transformed <- GM_transformed %>% recode_dx_bl() %>% replace_na_dx()
CSF_transformed <- CSF_transformed %>% recode_dx_bl() %>% replace_na_dx()
WM_transformed <- WM_transformed %>% recode_dx_bl() %>% replace_na_dx()
```

## Additional Transformations

We group the `pteducat` variable into categories and remove specific columns from the dataset.

```{r additional-transformations}

# Remove specific columns
Thick_transformed <- Thick_transformed %>%
  select(-l_medial_wall, -r_medial_wall)

# Get list of ROI columns
Thick_ROIs <- names(Thick_transformed)[8:157]
```

## Mixed Effects Model

We define a function to fit mixed effects models for each ROI and apply it to the dataset.

```{r mixed-effects-model}
# Function to fit mixed effects model
fit_mixed_effects_model_time_injury <- function(var, data) {
  formula <- as.formula(paste(var, "~ new_injury_severity * months_since_bl_exam + age + ptgender + field + tiv + cdrsb_bl + (1|rid)"))
  model <- lmer(formula, data = data, REML = FALSE)
  print(var)
  return(summary(model))
}

# Fit models for all ROIs
model_results_time_injury <- lapply(Thick_ROIs, function(var) fit_mixed_effects_model_time_injury(var, Thick_transformed))
```


```{r}
# Function to perform assumptions check
perform_assumptions_check <- function(data, outcome_var) {
  formula <- as.formula(paste(outcome_var, "~ new_injury_severity * months_since_bl_exam + age + ptgender + field + tiv + cdrsb_bl + (1|rid)"))
  model <- lmer(formula, data = data, REML = FALSE)
  
  # Residuals vs Fitted
  plot(resid(model) ~ fitted(model), main = paste("Residuals vs Fitted for", outcome_var), xlab = "Fitted values", ylab = "Residuals")
  abline(h = 0, col = "red")
  
  # Normal Q-Q
  qqnorm(resid(model), main = paste("Normal Q-Q for", outcome_var))
  qqline(resid(model))
  
  # Scale-Location
  plot(sqrt(abs(resid(model))) ~ fitted(model), main = paste("Scale-Location for", outcome_var), xlab = "Fitted values", ylab = "Sqrt |Residuals|")
  abline(h = 0, col = "red")
  
  # Random Effects (Random intercepts)
  ranef_data <- ranef(model)$rid
  qqnorm(ranef_data[,1], main = paste("Random Intercepts Q-Q for", outcome_var))
  qqline(ranef_data[,1])
  
  return(summary(model))
}

# Check assumptions for one of the ROIs
perform_assumptions_check(Thick_transformed, Thick_ROIs[10])
```

## Complete Analysis with FDR Correction

We define a function to perform a complete analysis for each dataset, including cross-validation and False Discovery Rate (FDR) correction.

```{r complete-analysis}
# Function to perform complete analysis
perform_complete_analysis <- function(data, outcome_vars, filename) {
  results <- lapply(outcome_vars, function(var) {
    cat(sprintf("Modeling %s: %d of %d\n", var, which(outcome_vars == var), length(outcome_vars)))
    formula <- as.formula(paste(var, "~ new_injury_severity * months_since_bl_exam + age + ptgender + field + dx + tiv + apoe4 + (1|rid)"))
    model <- lmerTest::lmer(formula, data = data, REML = FALSE)
    
    set.seed(333)
    cv_folds <- vfold_cv(data, v = 10, strata = !!sym(var))
    cv_results <- map(cv_folds$splits, ~{
      analysis_data <- analysis(.x)
      assessment_data <- assessment(.x)
      predictions <- predict(model, newdata = assessment_data, re.form = NA)
      observed <- assessment_data[[var]]
      data.frame(
        R_squared = cor(predictions, observed, use = "complete.obs")^2,
        RMSE = sqrt(mean((predictions - observed)^2))
      )
    })
    
    cv_summary <- summarise(bind_rows(cv_results), Avg_R_squared = mean(R_squared, na.rm = TRUE), Avg_RMSE = mean(RMSE, na.rm = TRUE))
    fixed_effects <- broom.mixed::tidy(model)
    conf_int <- confint(model, level = 0.95) %>% as.data.frame() %>% tibble::rownames_to_column("term") %>% dplyr::rename(lower = 2, upper = 3)
    
    inferential_stats_df <- fixed_effects %>%
      left_join(conf_int, by = "term") %>%
      mutate(Outcome_Variable = var, 
             Avg_R_squared = cv_summary$Avg_R_squared, 
             Avg_RMSE = cv_summary$Avg_RMSE, 
             BIC = BIC(model))
    
    return(inferential_stats_df)
  })
  
  all_p_values <- unlist(lapply(results, function(res) res$p.value))
  p_adjusted <- p.adjust(all_p_values, method = "BH")
  
  adjusted_index <- 1
  for (i in seq_along(results)) {
    n <- nrow(results[[i]])
    results[[i]]$p.value.adjusted <- p_adjusted[adjusted_index:(adjusted_index + n - 1)]
    adjusted_index <- adjusted_index + n
  }
  
  final_results_df <- bind_rows(results, .id = "ID")
  write_csv(final_results_df, filename)
  
  return(final_results_df)
}

# Define outcome variables for each dataset
outcome_vars_thickness <- Thick_ROIs
outcome_vars_csf <- GM_ROIs
outcome_vars_gm <- GM_ROIs
outcome_vars_wm <- GM_ROIs
outcome_vars_cog <- c("cdrsb", "adas11", "adas13", "adasq4", "mmse", "ravlt_immediate", "ravlt_learning", 
                      "ravlt_forgetting", "ravlt_perc_forgetting", "ldeltotal", "digitscor", "trabscor", "faq", 
                      "moca", "ecog_pt_mem", "ecog_pt_lang", "ecog_pt_visspat", "ecog_pt_plan", "ecog_pt_organ", 
                      "ecog_pt_divatt", "ecog_pt_total", "ecog_sp_mem", "ecog_sp_lang", "ecog_sp_visspat", "ecog_sp_plan", 
                      "ecog_sp_organ", "ecog_sp_divatt", "ecog_sp_total", "m_pac_cdigit", "m_pac_ctrails_b", "fdg", 
                      "av45", "tau", "ptau")

# Perform the complete analysis for each dataset
analysis_thickness <- perform_complete_analysis(Thick_transformed, outcome_vars_thickness, "Thick_final.csv")
analysis_csf <- perform_complete_analysis(CSF_transformed, outcome_vars_csf, "CSF_final.csv")
analysis_gm <- perform_complete_analysis(GM_transformed, outcome_vars_gm, "GM_final.csv")
analysis_wm <- perform_complete_analysis(WM_transformed, outcome_vars_wm, "WM_final.csv")
analysis_cog <- perform_complete_analysis(WM_transformed, outcome_vars_cog, "Cog_final.csv")
```



```{r}
# Function to plot model effects
plot_model_effects <- function(data, outcome_var) {
  formula <- as.formula(paste(outcome_var, "~ new_injury_severity * months_since_bl_exam + age + ptgender + field + tiv + cdrsb_bl + (1|rid)"))
  model <- lmer(formula, data = data, REML = FALSE)
  
  # Extract fixed effects
  fixed_effects <- fixef(model)
  
  # Create new data for prediction
  new_data <- expand.grid(
    new_injury_severity = levels(data$new_injury_severity),
    months_since_bl_exam = seq(min(data$months_since_bl_exam, na.rm = TRUE), max(data$months_since_bl_exam, na.rm = TRUE), length.out = 100),
    age = mean(data$age, na.rm = TRUE),
    ptgender = "Male",
    field = mean(data$field, na.rm = TRUE),
    tiv = mean(data$tiv, na.rm = TRUE),
    cdrsb_bl = mean(data$cdrsb_bl, na.rm = TRUE),
    rid = unique(data$rid)[1]
  )
  
  # Predict values
  predictions <- predict(model, newdata = new_data, re.form = NA)
  new_data$predicted <- predictions
  
  # Plot
  ggplot(new_data, aes(x = months_since_bl_exam, y = predicted, color = new_injury_severity)) +
    geom_line() +
    labs(title = paste("Predicted values for", outcome_var), x = "Months Since Baseline Exam", y = "Predicted Value") +
    theme_minimal()
}

# Plot effects for one of the ROIs
plot_model_effects(Thick_transformed, Thick_ROIs[35])
```

